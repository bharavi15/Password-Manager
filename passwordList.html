<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Password-List</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js" type="text/javascript">
	</script>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<style>
		.hidePassword {
			-webkit-text-security: disc
		}
	</style>
	<script>
		var allData;
		document.addEventListener("DOMContentLoaded", getData);

		function getData() {
			window.api.send("getDetails", "");
		}

		window.api.receive("setDetails", (data) => {
			allData = data.passwords
			renderData(allData)
		})

		function renderData(data) {
			let result = [];
			let count = 0;
			if (data.length === 0) {
				result.push(`<tr><td>NO SERVICES SAVED!</td></tr>`)
				document.getElementById("deleteAllButton").setAttribute("disabled", true)
			} else {
				document.getElementById("deleteAllButton").removeAttribute("disabled")
				result.push(
					`<tr><th class="center-align">Service</th><th class="center-align">Password</th><th class="center-align" colspan="3">Actions</th></tr>`
				)
				for (let row of data) {
					var rowcount = count++;
					result.push(`<tr id="service_${rowcount}">`);
					for (let cell of Object.keys(row)) {
						if (cell === 'password')
							result.push(`<td id="password_${rowcount}" class="hidePassword">*****</td>`)
						else
							result.push(`<td>${decodeURIComponent(row[cell])}</td>`);

					}
					result.push(`<td id="showPassword_${rowcount}" ><a class="waves-effect waves-light grey btn" onclick="togglePassword(${rowcount})"><i
						class="material-icons left">visibility</i>Show</a></td>`)
					result.push(`<td><a class="waves-effect waves-light red btn" onclick="deleteOneService(${rowcount})"><i
						class="material-icons left">delete</i>Delete</a></td>`)
					result.push('</tr>');
				}
			}
			document.getElementById("showServices").innerHTML = result.join('\n');

			document.getElementById("showServices").className = "centered striped";
		}

		window.api.receive("showMessage", (data) => {
			M.toast({
				html: data
			})
		})

		function showPassword(event) {
			console.log(event.srcElement.parentNode)
			id = event.srcElement.parentNode.id.split('_')[1]
			console.log(id)
			togglePassword(id)
		}

		function togglePassword(id) {
			if (document.getElementById('showPassword_' + id).innerHTML.includes('Show')) {
				console.log('in if')
				document.getElementById('password_' + id).innerHTML = decodeURIComponent(allData[id].password)
				document.getElementById('password_' + id).className = ""
				document.getElementById('showPassword_' + id).innerHTML = `<a class="waves-effect waves-light grey btn" onclick="togglePassword(${id})"><i
						class="material-icons left">visibility_off</i>Hide</a>`
			} else {
				console.log('in else')
				document.getElementById('password_' + id).innerHTML = "*****"
				document.getElementById('password_' + id).className = "hidePassword"
				document.getElementById('showPassword_' + id).innerHTML = `<a class="waves-effect waves-light grey btn" onclick="togglePassword(${id})"><i
						class="material-icons left">visibility</i>Show</a>`
			}

		}

		function deleteOneService(id) {
			var service = document.getElementById('service_' + id).cells[0].innerHTML
			console.log(service)
			window.api.send("deleteOneService", {
				service
			})
			getData()
		}

		function showSaveService() {
			window.api.send("showSaveService", "");
		}

		function showChangePassword() {
			window.api.send("showChangePassword", "")
		}

		function deleteAll() {
			if (confirm("Are you sure you want to delete all passwords?")) {
				window.api.send("deleteAll", "")
				getData()
			}
		}
	</script>
</head>

<body>
	<nav class="teal">
		<div class="nav-wrapper">
			<a class="brand-logo center">Password Manager</a>
		</div>

	</nav>
	<table class="centered">
		<tr>
			<td>
				<a class="waves-effect waves-light green btn" onclick="showSaveService()"><i
						class="material-icons left">add</i>Add
					Service</a>
			</td>
			<td>
				<a class="waves-effect waves-light blue btn" onclick="showChangePassword()"><i
						class="material-icons left">update</i>Change Password</a>
			</td>
			<td>
				<a class="waves-effect waves-light red btn" id="deleteAllButton" onclick="deleteAll()" disabled><i
						class="material-icons left">delete_forever</i>Delete All</a>
			</td>
		</tr>
	</table>
	<table id="showServices" style="overflow-y:auto">
	</table>
</body>

</html>